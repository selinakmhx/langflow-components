{
  "code": "import json\nimport os\n# 使用 Langflow 的标准组件基类（带有 build_results 等内部方法）\nfrom langflow.custom.custom_component.component import Component\n# 统一使用 lfx.io 提供的输入/输出类型，避免跨模块类型不一致\nfrom langflow.inputs.inputs import MessageInput\nfrom langflow.template import Output\nfrom langflow.schema.message import Message\n\n\nclass XHSFilterComponent(Component):\n    display_name: str = \"小红书数据过滤器\"\n    description: str = \"根据模式（关键词、评论、用户）过滤小红书 API 返回的 JSON，尽量保留有用信息，仅移除明确无用的技术噪声。支持多图片/多视频 URL 全量保留。\"\n    icon = \"filter\"\n    name = \"XHSFilter\"\n\n    inputs = [\n        MessageInput(\n            name=\"input_message\",\n            display_name=\"输入消息\",\n            info=\"包含 JSON 数据的消息对象。\",\n        ),\n    ]\n\n    outputs = [\n        Output(display_name=\"过滤后的消息\", name=\"filtered_message\", method=\"filter_message\"),\n    ]\n\n    # === 通用过滤策略 ===\n    def should_keep_key(self, key: str) -> bool:\n        \"\"\"\n        判断某个键是否应被保留（模式通用规则）。\n        设计原则：\n        - 保留所有明显与业务相关的键（id、用户、笔记、媒体、统计、计数、时间、URL 等）\n        - 仅过滤确定无用的调试/技术指标键（如 ssim/psnr/vmaf/rotate/quality_type 等）\n        \"\"\"\n        if not isinstance(key, str):\n            return False\n\n        # 明确保留：结构/业务核心字段\n        keep_exact = {\n            # 顶部与结构\n            \"模式\", \"环境\", \"基础地址\", \"数据\", \"data\", \"原始\", \"meta\", \"请求耗时\", \"版本选择\", \"统计\",\n            \"页码\", \"还有更多\", \"下一页游标\", \"result\", \"items\", \"ads\", \"note\", \"notes\", \"comments\",\n            \"请求信息\", \"code\", \"message\", \"message_cn\", \"recordTime\",\n            # 用户信息\n            \"用户\", \"用户信息\", \"user\", \"userid\", \"user_id\", \"nickname\", \"red_id\",\n            \"official_verified\", \"red_official_verified\",\n            # 用户模式补充保留字段（避免误删）\n            \"liked\", \"fans\", \"collected\", \"ip_location\", \"location\", \"images\",\n            \"user_desc_info\", \"interactions\",\n            # 笔记/内容\n            \"id\", \"note_id\", \"title\", \"display_title\", \"desc\", \"content\", \"type\",\n            \"time_desc\", \"create_time\", \"timestamp\", \"update_time\",\n            # 计数相关\n            \"liked_count\", \"likes\", \"comments_count\", \"collected_count\", \"share_count\",\n            \"nice_count\", \"view_count\", \"is_goods_note\",\n            # 媒体相关\n            \"url\", \"urls\", \"share_link\", \"images\", \"image\", \"images_list\",\n            \"cover\", \"thumbnail\", \"first_frame\",\n            \"video_info\", \"video_info_v2\", \"media\", \"stream\", \"streams\",\n            \"h264\", \"h265\", \"master_url\", \"backup_urls\",\n            # 评论模式中文字段（明确保留）\n            \"评论ID\", \"昵称\", \"小红书号\", \"评论内容\", \"点赞数\", \"发布时间\", \"发布地点\",\n            \"二级评论数\", \"评论级别\", \"作者ID\", \"是否官方认证\",\n        }\n\n        # 模糊保留：包含这些子串的键也保留（尽量覆盖可能的变体）\n        keep_substrings = [\n            \"url\", \"image\", \"video\", \"note\", \"user\", \"count\", \"time\", \"desc\", \"title\",\n            # 兼容中文字段的模糊保留（避免误删有相关性的中文键）\n            \"内容\", \"地点\", \"昵称\", \"评论\", \"认证\", \"ID\",\n        ]\n\n        if key in keep_exact:\n            return True\n        for sub in keep_substrings:\n            if sub in key:\n                return True\n        return False\n\n    def is_noise_key(self, key: str) -> bool:\n        \"\"\"\n        判断某个键是否为明确无用的技术噪声（跨模式统一过滤）。\n        注意：只过滤高度确定无用的指标，避免误删潜在相关字段。\n        \"\"\"\n        if not isinstance(key, str):\n            return False\n        noise_exact = {\n            # 视频编码评估/技术指标，在业务侧通常完全用不到\n            \"ssim\", \"psnr\", \"vmaf\", \"rotate\", \"quality_type\", \"stream_desc\",\n            \"weight\", \"size\", \"volume\", \"audio_bitrate\", \"audio_channels\", \"video_bitrate\",\n            \"default_stream\",\n        }\n        return key in noise_exact\n\n    def recursive_filter_with_rules(self, obj):\n        \"\"\"根据通用规则递归过滤对象。保留相关性强的字段，仅移除明确噪声。\"\"\"\n        if isinstance(obj, list):\n            return [self.recursive_filter_with_rules(item) for item in obj]\n        elif isinstance(obj, dict):\n            new_dict = {}\n            for k, v in obj.items():\n                # 优先过滤明确噪声键\n                if self.is_noise_key(k):\n                    continue\n                # 保留相关键，递归处理其值\n                if self.should_keep_key(k):\n                    new_dict[k] = self.recursive_filter_with_rules(v)\n            return new_dict\n        else:\n            return obj\n\n    def filter_search_data(self, data):\n        \"\"\"过滤“按关键词采集笔记”模式的数据（尽量保留相关信息）。\"\"\"\n        # 基于通用规则做一次过滤\n        filtered = self.recursive_filter_with_rules(data)\n        # 兜底：确保顶层保留“模式”和“meta”\n        if isinstance(data, dict):\n            if \"模式\" in data:\n                filtered[\"模式\"] = data.get(\"模式\")\n            if \"meta\" in data:\n                filtered[\"meta\"] = self.recursive_filter_with_rules(data.get(\"meta\"))\n        return filtered\n\n    def filter_comment_data(self, data):\n        \"\"\"过滤“按笔记采集评论”模式的数据（尽量保留相关信息）。\"\"\"\n        filtered = self.recursive_filter_with_rules(data)\n        if isinstance(data, dict):\n            if \"模式\" in data:\n                filtered[\"模式\"] = data.get(\"模式\")\n            if \"meta\" in data:\n                filtered[\"meta\"] = self.recursive_filter_with_rules(data.get(\"meta\"))\n        return filtered\n\n    def filter_user_data(self, data):\n        \"\"\"过滤“按用户采集笔记”模式的数据（尽量保留相关信息）。\"\"\"\n        filtered = self.recursive_filter_with_rules(data)\n        if isinstance(data, dict):\n            if \"模式\" in data:\n                filtered[\"模式\"] = data.get(\"模式\")\n            if \"meta\" in data:\n                filtered[\"meta\"] = self.recursive_filter_with_rules(data.get(\"meta\"))\n        # 顶层聚合：将 数据[*].原始.data.notes 聚合为顶层 notes_flat，便于直接查看\n        try:\n            notes_flat = []\n            if isinstance(filtered, dict) and isinstance(filtered.get(\"数据\"), list):\n                for item in filtered.get(\"数据\", []):\n                    if isinstance(item, dict):\n                        raw = item.get(\"原始\")\n                        if isinstance(raw, dict):\n                            inner_data = raw.get(\"data\")\n                            if isinstance(inner_data, dict):\n                                notes = inner_data.get(\"notes\")\n                                if isinstance(notes, list):\n                                    notes_flat.extend(notes)\n            if notes_flat:\n                filtered[\"notes_flat\"] = notes_flat\n    ..."
}
{
  "results": {},
  "artifacts": {
    "filtered_message": {
      "repr": "输入的不是有效 JSON 字符串或有效文件路径。",
      "raw": "{}",
      "type": "text"
    }
  },
  "outputs": {
    "filtered_message": {
      "message": "{}",
      "type": "text"
    }
  },
  "logs": {
    "filtered_message": []
  },
  "messages": [],
  "timedelta": null,
  "duration": null,
  "component_display_name": "小红书数据过滤器",
  "component_id": "XiaohongshuCommentAnalyzer-Tj0Dr",
  "used_frozen_result": false
}