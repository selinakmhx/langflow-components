

一、目标与整体设计原则
- 目标：实现一个全新的 Langflow 自定义组件“RedNote（小红书）”用于：
  - 模式一：按关键词采集笔记（支持笔记类型、排序、页数范围、时间范围筛选；可选作者详情、必拉笔记详情获取正文）。
  - 模式二：按笔记采集评论（优先 Note Comment v4，失败回退 v2；可选采集二级评论）。
  - 模式三：按用户信息采集笔记（优先 User Note List v4，失败回退 v2；必要时拉 Note Detail v7 获取正文）。
- 输出：返回标准化 JSON（字段完全符合“工作流需求.md”的输出项），统一时间单位（秒），封面与视频链接规则稳定，笔记链接格式统一，支持作者额外信息开关。
- 错误处理：任何请求失败或字段缺失都返回完整错误信息（原因分类、请求路径且隐藏 token、HTTP 状态码、业务 code、字段缺失列表、可疑原因提示）。
- 可配置：全球区/国内区域与 token 可随时修改；其他输入字段动态展示与校验。
- 设计原则：遵循 SOLID 与设计模式
  - 单一职责：请求客户端、模式策略、字段映射分别独立。
  - 开闭原则：支持新 API 与字段扩展，不影响现有逻辑。
  - 里氏替换：各模式策略可互换使用一个统一接口。
  - 接口隔离：每个模式只暴露自身必要的输入参数。
  - 依赖倒置：业务依赖抽象策略与客户端接口。
  - 工厂模式：按区域创建 HTTP 客户端。
  - 策略模式：三种模式为三套策略；评论排序与搜索排序为可替换策略。
  - 观察者模式（可选，内部事件流）：用于向前台输出进度事件或日志（例如：请求开始/结束/回退触发）。

二、组件命名与文件结构（建议）
- 组件类名：XiaohongshuRedNote（中文显示：小红书采集组件）
- 文件路径：
  - 后端组件文件：langflow/src/lfx/src/lfx/components/custom_component/xiaohongshu_rednote.py
  - 注册入口：langflow/src/lfx/src/lfx/components/custom_component/__init__.py 中加入 "XiaohongshuRedNote": "xiaohongshu_rednote"
- 内部结构（同文件内或拆分为子模块）
  - HttpClient：负责域名、token 管理与 GET 调用、错误分类、token 脱敏。
  - Strategies：
    - KeywordNotesStrategy（模式一）
    - NoteCommentsStrategy（模式二）
    - UserNotesStrategy（模式三）
  - Mappers：字段映射与标准化（封面、视频、时间、标签、作者信息聚合）
  - Errors：统一错误数据结构、掩码工具
  - Enums：排序、类型与时间范围枚举映射
  - Validators：输入校验（例如 UID 格式、页码范围）

三、前台交互与输入字段（动态展示）
- 全局输入（始终显示）
  - environment（下拉）：中国区 / 全球区
  - token（字符串）：Just One API Token，可为空（为空则使用组件常量，强烈建议前台填写真实 token）
  - mode（下拉）：按关键词采集笔记 / 按笔记采集评论 / 按用户信息采集笔记
- 模式一（按关键词采集笔记）显示的输入
  - keyword（文本，必填）：搜索词
  - note_type（下拉）：全部、图文、视频（内部映射 _0/_2/_1）
  - sort（下拉）：综合、最热、最新、最多评论、最多收藏
    - 说明：v3 支持综合/最热/最新；v2 还支持最多评论、最多收藏
    - 决策：当选择“最多评论/最多收藏/时间范围”时优先走 v2；否则优先走 v3
  - start_page（整数 ≥1，默认 1）：开始页
  - end_page（整数 ≥ start_page，默认 1）：结束页
  - time_range（下拉）：一天内 / 一周内 / 半年内
    - 决策：time_range 不为空时优先使用 v2 的 noteTime；若 v3 被强制选择，则由组件做客户端时间过滤（兜底）
  - include_note_detail（布尔，默认开启）：是否对每条搜索结果调用 Note Detail v7 获取“正文与更完整信息”
  - include_author_detail（布尔，默认关闭）：是否对每条笔记调用 User Info v4 获取作者粉丝数、获赞与收藏合并值、简介、主页链接等
- 模式二（按笔记采集评论）显示的输入
  - note_input（文本，必填）：笔记链接或笔记 ID（支持 https://www.xiaohongshu.com/explore/<id> 或直接 ID）
  - comment_mode（下拉）：默认、最新、最多点赞
    - 决策：最多点赞为“客户端排序”，服务端排序仅支持 normal/latest
  - include_sub_comments（布尔，默认关闭）：是否采集二级评论（Note Sub Comment v2）
  - comments_last_cursor（文本，可选）：评论上一页游标（仅 v2）
- 模式三（按用户信息采集笔记）显示的输入
  - xhs_user_id（文本，必填）：用户 UID
- user_notes_last_cursor（已移除）：分页已改为自动依据接口返回的 cursor 翻页，无需外部输入
  - force_user_detail（布尔，默认关闭）：是否强制为每条笔记都调用 Note Detail v7 获取正文（默认仅当列表缺失 desc 时才拉详情）

四、接口调用策略与路径（严格按文档）
- 域名选择：
  - 中国区：http://47.117.133.51:30015
  - 全球区：https://api.justoneapi.com
- 模式一（按关键词采集笔记）
  - 主用：
    - 当包含 time_range（一天内/一周内/半年内）或选择“最多评论/最多收藏”时，优先用 Note Search v2：
      GET /api/xiaohongshu/search-note/v2?token=&keyword=&page=&sort=&noteType=&noteTime=
    - 否则使用 Note Search v3：
      GET /api/xiaohongshu/search-note/v3?token=&keyword=&page=&sort=&noteType=
  - 详情拉取（正文）：
    - 优先：Note Detail v7 → GET /api/xiaohongshu/get-note-detail/v7?token=&noteId=
    - 兜底：如 v7 失败，可回退 v3（必要时）→ GET /api/xiaohongshu/get-note-detail/v3?token=&noteId=
    - 不使用 v9（xsec_token 需要笔记级分享链接，不适合本组件默认流程）
  - 作者详情（可选）：
    - User Info v4 → GET /api/xiaohongshu/get-user/v4?token=&userId=
    - 回退 v3 → GET /api/xiaohongshu/get-user/v3?token=&userId=
- 模式二（按笔记采集评论）
  - 一级评论：
    - 优先：Note Comment v4（仅第一页）→ GET /api/xiaohongshu/get-note-comment/v4?token=&noteId=
    - 失败回退：Note Comment v2（分页）→ GET /api/xiaohongshu/get-note-comment/v2?token=&noteId=&sort=&lastCursor=
  - 二级评论：
    - Sub Comment v2 → GET /api/xiaohongshu/get-note-sub-comment/v2?token=&noteId=&commentId=&lastCursor=
- 模式三（按用户信息采集笔记）
  - 用户笔记列表：
    - 优先：User Note List v4 → GET /api/xiaohongshu/get-user-note-list/v4?token=&userId=&lastCursor=
    - 回退：User Note List v2 → GET /api/xiaohongshu/get-user-note-list/v2?token=&userId=&lastCursor=
  - 正文获取：
    - Note Detail v7（必要时拉取；force_user_detail 开启时为每条笔记都拉取）

五、字段映射与标准化规则（严格、可回退）
- 通用规范
  - 时间：统一转换为秒（v4 评论返回为毫秒，需要 /1000）。
  - 笔记链接：统一为 https://www.xiaohongshu.com/explore/<note_id>
  - 封面图：
    - 视频：note.video_info_v2.image.first_frame（优先）或 image.thumbnail
    - 图片：note.images_list[0].url_size_large（若 url 为空用 url_size_large）
  - 视频链接：
    - note.video_info_v2.media.stream.h264/h265[*].master_url（优先 default_stream==1，若无则选分辨率最高）
    - live_photo：images_list[].live_photo.media.stream.h265/h264[].master_url
  - 正文：
    - 搜索返回的 desc 常为预览，不保证完整。
    - 完整正文来自 Note Detail v7 的 data[].note_list[].desc。
    - 遍历 note_list，取 type 为 normal 或 video 的条目里最长的 desc；为空时可标注为“摘要”或返回空。
  - 标签提取：从正文按正则 r"#([^#]+?)#" 提取，返回数组（去重、小写/原样保留均可配置）。
  - 作者认证：user.red_official_verified 或 red_official_verify_type != 0；若均缺失，则 false。
- 模式一（按关键词采集笔记）输出字段（每条笔记对象，键使用中文，便于前台用户）
  - 标题：note.title
  - 点赞数：note.liked_count
  - 评论数：note.comments_count
  - 收藏数：note.collected_count
  - 好看数：note.nice_count（若缺失返回 0）
  - 分享数：note.shared_count
  - 笔记类型：note.type（normal|video）
  - 笔记id：note.id
  - 笔记链接：拼接 https://www.xiaohongshu.com/explore/<note_id>
  - 笔记正文：来自 Note Detail v7 的 note_list[].desc（若详情失败，降级使用搜索返回的 note.desc 并标注“摘要”）
  - 笔记tag：由正文解析出的数组
  - 封面图链接：规则见“通用规范”
  - 视频链接：规则见“通用规范”
  - 发布时间：统一为秒（note.timestamp 秒；若无用 note.update_time 毫秒转秒）
  - 作者昵称：note.user.nickname
  - 小红书号：note.user.red_id
  - 是否官方认证：见“作者认证”
  - 作者粉丝数：User Info v4/v3 返回 data.fans
  - 作者获赞与收藏数（合并指标）：
    - 优先 data.interactions 中 type == "interaction" 的项的 count
    - 若不存在，回退 data.note_num_stat.liked + data.note_num_stat.collected 或 liked + collected
    - 不使用 share_info_v2.content 的展示文本
  - 作者简介：优先 data.user_desc_info.desc；否则 data.desc
  - 作者主页链接：data.share_link；若缺失可用 https://www.xiaohongshu.com/user/profile/{data.userid} 拼接
- 模式二（按笔记采集评论）输出字段（每条评论对象，键中文）
  - 昵称：comment.user.nickname
  - 评论内容：comment.content
  - 点赞数：comment.like_count
  - 发布时间：统一为秒（v4 为毫秒；v2 为秒）
  - 发布地点：comment.ip_location 或 user.ip_location（若缺失返回空）
  - 评论级别：根评论/二级评论
  - 用户昵称：comment.user.nickname（与“昵称”相同）
  - 小红书号：comment.user.red_id
  - 作者ID：comment.user.userid 或 user_id（按版本映射）
  - 是否官方认证：按“作者认证”规则
  - 二级评论（仅 include_sub_comments 开启时）：作为子数组 sub_comments 返回，字段同上（子评论对象不再重复“评论级别”，默认视为二级）
- 模式三（按用户信息采集笔记）输出字段（每条笔记对象，键中文）
  - 用户昵称：notes[].user.nickname
  - 笔记ID：notes[].id
  - 笔记链接：拼接 https://www.xiaohongshu.com/explore/<note_id>
  - 笔记标题：优先 notes[].display_title；否则 notes[].title
  - 笔记正文：notes[].desc（如不完整则按 Note Detail v7 获取）
  - 点赞数：notes[].likes
  - 评论数：notes[].comments_count
  - 收藏数：notes[].collected_count
  - 好看数（仅视频笔记）：notes[].nice_count（缺失返回 0）
  - 分享次数：notes[].share_count
  - 笔记图片链接：图文 → images_list[].url（或 url_size_large）；视频 → video_info_v2.image.first_frame（或 images_list[0].url）
  - 浏览数：notes[].view_count（可能为 0 或不可靠）
  - 发布时间：notes[].create_time（秒）
  - 是否是商品笔记：notes[].is_goods_note（布尔）
  - 笔记类型：notes[].type（video/image）

六、错误处理与输出结构（必须）
- 输出总结构
  - 成功：
    - { "status": "success", "mode": "<模式>", "domain": "<中国区|全球区>", "data": { ...标准化字段... }, "meta": { "request_count": n, "version": "vX/vY", "filtered": {...} } }
  - 失败：
    - {
        "status": "error",
        "mode": "<模式>",
        "domain": "<中国区|全球区>",
        "error": {
          "type": "<auth_error|rate_limit|server_error|http_error|param_error|retry_or_moved|unknown>",
          "http_status": 4xx/5xx/… 或 null,
          "business_code": code 或 null,
          "message": "接口返回的错误信息或本地解析错误说明",
          "request_path": "<域名+路径+query（token 已隐藏）>",
          "missing_fields": ["缺失的字段名（如 liked_count、images_list）"],
          "possible_causes": ["可能原因，如 token 为空或无效、参数错误、接口版本不可用、频率限制、目标数据已被删除、网关缓存不一致..."],
          "retry_suggestion": "如：尝试切换到 v2/v3 或切换国内/全球域，或检查 noteId/userId 是否正确"
        }
      }
- 请求路径隐藏 token：
  - 规则：token 显示为头尾脱敏，如 abc***wxyz；或完全替换为 ***
- 字段缺失：
  - 当某字段不存在时，返回值中该字段设为 null 或 0，并在 missing_fields 记录该字段名。
- 回退链条：
  - v4→v2、v7→v3 等失败时记录回退轨迹（meta.fallbacks：["note_comment_v4→v2"]）。

七、判定与过滤策略
- 搜索时间范围：
  - v2 提供 noteTime（一天内/一周内/半年内），优先使用 v2。
  - 若使用 v3（例如你选择了 v3 强制），则客户端过滤：比较 note.timestamp 或 note.update_time 秒是否在范围内。
- 排序：
  - 搜索“最多评论/最多收藏”：v2 支持服务端排序。
  - 评论“最多点赞”：客户端对返回结果按 like_count 排序（保留原序列也可通过 meta 原序号）。
- 广告过滤：
  - 搜索返回 items 可能含 model_type="ads"：要么过滤掉广告，要么兼容在 ads.note 下取字段（建议默认过滤 ads）。
- 时间单位统一：统一秒，v4 评论毫秒需 /1000。

八、组件输出示例（简版）
- 模式一（keyword）成功示例
  - status: success
  - data: notes: [ { 标题, 点赞数, 评论数, 收藏数, 好看数, 分享数, 笔记类型, 笔记id, 笔记链接, 笔记正文, 笔记tag[], 封面图链接, 视频链接, 发布时间, 作者昵称, 小红书号, 是否官方认证, 作者粉丝数, 作者获赞与收藏数, 作者简介, 作者主页链接 } ... ]
- 模式二（comments）成功示例
  - status: success
  - data: comments: [ { 昵称, 评论内容, 点赞数, 发布时间, 发布地点, 评论级别, 用户昵称, 小红书号, 作者ID, 是否官方认证, sub_comments: [ ... ]? } ... ]
- 模式三（user notes）成功示例
  - status: success
  - data: notes: [ { 用户昵称, 笔记ID, 笔记链接, 笔记标题, 笔记正文, 点赞数, 评论数, 收藏数, 好看数, 分享次数, 笔记图片链接, 浏览数, 发布时间, 是否是商品笔记, 笔记类型 } ... ]

九、与现有组件的差异与修正点
- 搜索模式默认版本选择改进：
  - 根据 time_range 与排序选项动态选择 v2/v3（原组件仅以 v3 为主，导致 time_range 无法服务端筛选）。
- 评论模式回退优先级修正：
  - 明确“优先 v4、失败回退 v2”，并在 error/meta 中记录回退路径。
- 正文获取策略严格化：
  - 明确只使用 Note Detail v7 的 note_list[].desc 作为“完整正文”，并在 v7 不可用时回退；搜索返回的 desc 仅作为摘要，区分标识。
- 字段完整性与错误输出：
  - 对每个字段都有缺失处理与 missing_fields 汇总；请求失败时详细记录路径（隐藏 token）、业务 code、HTTP 状态与可能原因。
- 输出键采用中文字段名：
  - 便于前台用户理解（你的用户友好要求），同时内部有英文注释与映射。

十、测试与验收计划
- 基础连通性测试：
  - 全球区/国内区域域名切换；token 正确/缺失/错误；参数校验（页码范围、noteId、userId）。
- 模式一：
  - v3：综合/最热/最新，各页采集，include_note_detail 开关，作者详情开关。
  - v2：最多评论/最多收藏、time_range 三档；desc 完整性校验；广告过滤。
- 模式二：
  - v4 成功返回，子评论关闭。
  - v4 失败→自动走 v2，分页与 lastCursor 正常；子评论开启，拉取 v2 回复，时间单位统一。
- 模式三：
  - v4 返回正常，缺失 desc 时拉 v7；force_user_detail 开启全量拉取。
  - v4 失败→自动走 v2；输出字段完整性验证。
- 错误案例：
  - 401/403：token 空或非法；429：频率限制；404：noteId 不存在；参数错误（sort 值非法）；网络异常。
  - 验证错误输出结构包含：type/http_status/business_code/message/request_path（隐藏 token）/missing_fields/possible_causes/retry_suggestion。
- 与 apitest 目录对齐：
  - 使用 apitest 文件进行字段与路径核对（注意：顶部中文描述可能有误，以 JSON 字段为准）。

十一、安全与隐私
- token 不在日志与错误输出中明文显示；仅头尾掩码或完全替换。
- 请求参数记录中隐藏 token。
- 不缓存用户隐私数据。

十二、性能与扩展
- 并发控制：详情与作者信息拉取可设置并发上限，避免触发限频（默认串行或小并发）。
- 将来扩展：
  - 支持 Note Detail v9（需笔记级分享链接的 xsec_token）。
  - 支持更多排序/筛选。
  - 支持用户搜索/话题搜索等（文档已有接口）。

十三、代码实现概览（你确认后我再写代码）
- 类：XiaohongshuRedNote(Component)
  - inputs/outputs：遵循 langflow.io 输入输出定义，动态展示。
  - build_output()：根据 mode 调用对应策略，汇总结果与错误信息。
- HttpClient
  - get(base_url, path, params)：统一加 token、隐藏 token、错误分类（auth_error/rate_limit/server_error/http_error/param_error/...），解析 JSON。
- Strategies
  - KeywordNotesStrategy
    - 构建 v2/v3 请求；分页采集；客户端/服务端排序；时间范围；详情与作者信息拉取；映射输出。
  - NoteCommentsStrategy
    - v4 优先，失败回退 v2；最多点赞客户端排序；子评论拉取；时间单位统一；映射输出。
  - UserNotesStrategy
    - v4 优先，失败回退 v2；必要时拉详情；映射输出。
- Mappers
  - NoteMapper：封面、视频、标签、正文、笔记链接、作者认证、时间统一。
  - UserMapper：fans、interactions 合并值、简介、主页链接。
  - CommentMapper：字段统一与时间单位转换、子评论聚合。
- Errors
  - ErrorBuilder：构造错误字典；missing_fields 汇总；回退轨迹记录。

如果以上文档符合你的预期，请告诉我是否：
- 输出键使用中文（当前方案）保留
- 模式一默“根据选择动态决定 v2/v3
- 需要在 meta 中返回更多可选信息（如原始返回的部分字段或请求耗时）？
